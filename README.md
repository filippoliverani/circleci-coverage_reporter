# CircleCI::CoverageReporter

[![CircleCI](https://circleci.com/gh/increments/circleci-coverage_reporter.svg?style=svg)](https://circleci.com/gh/increments/circleci-coverage_reporter)

**CircleCI::CoverageReporter** reports test coverage to your GitHub repository.

## Example

![image](https://cloud.githubusercontent.com/assets/96157/23824715/e16f0eac-06be-11e7-81e8-f818b14a52b4.png)

## Getting started

1.  Add CircleCI::CoverageReporter to your `Gemfile` and `bundle install`:

    ```ruby
    gem 'circleci-coverage_reporter', group: :test
    ```

2.  Load `circleci/coverage_reporter/rake_task` in your `Rakefile`:

    ```ruby
    require 'circleci/coverage_reporter/rake_task' if ENV['CIRCLECI']
    ```

3.  Issue CircleCI and GitHub tokens and add them to build environment variables as follows:

    Name                               | Value
    -----------------------------------|----------------------------------------------------------------
    `COVERAGE_REPORTER_CIRCLECI_TOKEN` | CircleCI API token with "view-builds" scope
    `COVERAGE_REPORTER_VCS_TOKEN`      | GitHub personal access token with "repo" or "public_repo" scope

4.  Add the following step to your `circle.yml`:

    ```yaml
    test:
      post:
      - bundle exec rake circleci:report_coverage
    ```

## Run manually

You must configure `circleci_token` and `vcr_token` before `CircleCI::CoverageReporter.run`:

```ruby
CircleCI::CoverageReporter.configure do |config|
  config.circleci_token = YOUR_CIRCLECI_API_TOKEN
  config.vcr_token = YOUR_GITHUB_PERSONAL_ACCESS_TOKEN
end

CircleCI::CoverageReporter.run
```

## Reporters
### SimpleCov

`CircleCI::CoverageReporter::SimpleCov::Reporter` handles coverage files generated by
[SimpleCov](https://github.com/colszowka/simplecov). It is used by default.

It expects that coverage files are located in `$CIRCLE_ARTIFACTS/coverage` directory:

```ruby
# spec/spec_helper.rb
require 'simplecov'
# Save to CircleCI's artifacts directory if we're on CircleCI
SimpleCov.coverage_dir(File.join(ENV['CIRCLE_ARTIFACTS'], 'coverage')) if ENV['CIRCLECI']
SimpleCov.start
```

If you put files in another directory, say `$CIRCLE_ARTIFACTS/foo/bar`, you have to set reporter as follows:

```ruby
CircleCI::CoverageReporter.configure do |config|
  config.reporters = [CircleCI::CoverageReporter::SimpleCov::Reporter.new('foo/bar')]
end
```

## License

The gem is available as open source under the terms of the [MIT License](http://opensource.org/licenses/MIT).
